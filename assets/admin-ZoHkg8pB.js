import"./modulepreload-polyfill-B5Qt9EMX.js";const y={list:"/api/admin/products",create:"/api/admin/products",update:t=>`/api/admin/products/${encodeURIComponent(t)}`,remove:t=>`/api/admin/products/${encodeURIComponent(t)}`};async function b(){const t=await fetch(y.list,{credentials:"same-origin"}),e=await t.json();if(!t.ok||!e.ok)throw new Error(e.error||`HTTP ${t.status}`);return e.items||[]}async function $(t){const e=await fetch(y.create,{method:"POST",headers:{"content-type":"application/json"},credentials:"same-origin",body:JSON.stringify(t)}),n=await e.json();if(!e.ok||!n.ok)throw new Error(n.error||`HTTP ${e.status}`)}async function k(t,e){const n=await fetch(y.update(t),{method:"PUT",headers:{"content-type":"application/json"},credentials:"same-origin",body:JSON.stringify(e)}),i=await n.json();if(!n.ok||!i.ok)throw new Error(i.error||`HTTP ${n.status}`)}async function L(t){const e=await fetch(y.remove(t),{method:"DELETE",credentials:"same-origin"}),n=await e.json();if(!e.ok||!n.ok)throw new Error(n.error||`HTTP ${e.status}`)}const a=t=>document.getElementById(t);function u(t){a("status").textContent=t}function _(t){return t?t.startsWith("./")?t.slice(1):t:""}function j(t){return(t||"").split("|").map(e=>e.trim()).filter(Boolean)}function T(t){return Array.isArray(t)?t.join("|"):""}function E(t,e){const n=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),i=document.createElement("a");i.href=URL.createObjectURL(n),i.download=t,i.click(),URL.revokeObjectURL(i.href)}let d=[],h=[],g=null;function s(t){return(t??"").toString().replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[e])}function C(){const t=a("cat"),e=[...new Set(d.map(n=>n.category).filter(Boolean))].sort((n,i)=>n.localeCompare(i,"ar"));t.innerHTML='<option value="">كل الأقسام</option>'+e.map(n=>`<option value="${s(n)}">${s(n)}</option>`).join("")}function w(){const t=(a("q").value||"").trim().toLowerCase(),e=a("cat").value||"";h=d.filter(n=>{if(e&&n.category!==e)return!1;if(!t)return!0;const i=Array.isArray(n.tags)?n.tags.join(" "):"";return`${n.name||""} ${n.company||""} ${i}`.toLowerCase().includes(t)}),B()}function B(){const t=a("tbody");t.innerHTML=h.map(e=>{const n=_(e.image_url||"");return`
      <tr data-uid="${s(e._uid)}">
        <td>${n?`<img class="img" src="${s(n)}" alt="">`:'<span class="pill">—</span>'}</td>
        <td><div style="font-weight:800">${s(e.name||"")}</div><div class="pill">${s(e.company||"")}</div></td>
        <td>${s(e.category||"")}</td>
        <td>${e.price??""}</td>
        <td>${e.sale_price??""}</td>
        <td><input class="tog" data-k="in_stock" type="checkbox" ${e.in_stock?"checked":""}></td>
        <td><input class="tog" data-k="by_weight" type="checkbox" ${e.by_weight?"checked":""}></td>
        <td class="actions">
          <button class="iconBtn" data-act="edit">تعديل</button>
          <button class="iconBtn" data-act="del">حذف</button>
        </td>
      </tr>
    `}).join(""),u(`عدد المنتجات: ${h.length}`)}function o(t,e){a(t).value=e??""}function f(t,e){a(t).checked=!!e}function v(t){a("modal").classList.add("show"),g=t?._uid||null,a("modalTitle").textContent=g?`تعديل: ${t.name||t._uid}`:"إضافة منتج",a("form").reset(),o("_uid",t?._uid||""),o("id",t?.id||""),o("name",t?.name||""),o("category",t?.category||""),o("company",t?.company||""),o("unit",t?.unit||""),o("price",t?.price??""),o("sale_price",t?.sale_price??""),o("image_url",_(t?.image_url||"")),o("tags",T(t?.tags)),o("description",t?.description||""),f("in_stock",t?.in_stock??!0),f("by_weight",t?.by_weight??!1),f("is_featured",t?.is_featured??!1),f("is_new",t?.is_new??!1)}function p(){a("modal").classList.remove("show")}function U(){return{_uid:(a("_uid").value||"").trim(),id:(a("id").value||"").trim(),name:(a("name").value||"").trim(),category:(a("category").value||"").trim(),company:(a("company").value||"").trim(),unit:(a("unit").value||"").trim(),price:a("price").value===""?null:Number(a("price").value),sale_price:a("sale_price").value===""?null:Number(a("sale_price").value),image_url:_((a("image_url").value||"").trim()),tags:j(a("tags").value),description:(a("description").value||"").trim(),in_stock:a("in_stock").checked,by_weight:a("by_weight").checked,is_featured:a("is_featured").checked,is_new:a("is_new").checked}}async function l(){u("جاري التحميل…"),d=await b(),C(),w()}document.addEventListener("DOMContentLoaded",async()=>{a("reloadBtn").onclick=()=>l().catch(t=>u("خطأ: "+t.message)),a("addBtn").onclick=()=>v(null),a("closeModal").onclick=p,a("cancelBtn").onclick=p,a("q").oninput=w,a("cat").onchange=w,a("exportBtn").onclick=()=>E("tantkoki-products.json",d),a("tbody").addEventListener("click",async t=>{const e=t.target.closest("button");if(!e)return;const i=e.closest("tr")?.dataset?.uid,r=d.find(c=>c._uid===i);if(!r)return;const m=e.dataset.act;if(m==="edit")return v(r);if(m==="del"){if(!confirm(`حذف المنتج: ${r.name} ؟`))return;try{await L(i),await l()}catch(c){alert(c.message)}}}),a("tbody").addEventListener("change",async t=>{const e=t.target;if(!e.classList.contains("tog"))return;const i=e.closest("tr")?.dataset?.uid,r=d.find(c=>c._uid===i);if(!r)return;const m=e.dataset.k;r[m]=e.checked;try{await k(i,r),u("تم الحفظ ✅")}catch(c){alert(c.message),await l()}}),a("form").addEventListener("submit",async t=>{t.preventDefault();const e=U();if(!e._uid||!e.name||!e.category||e.price==null)return alert("لازم _uid + الاسم + القسم + السعر");try{g?await k(g,e):await $(e),p(),await l()}catch(n){alert(n.message)}}),l().catch(t=>u("خطأ: "+t.message))});
